<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="keywords" content="Implementing-thermal-solver.md,  ">

<title>Implementing thermal solver | Kratos Multiphysics Documentation</title>

<link rel="stylesheet" href="/css/syntax.css">

<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="/css/modern-business.css">

<!-- Latest compiled and minified CSS -->
<!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"> -->
<link rel="stylesheet" href="/css/bootstrap.min.css">
<link rel="stylesheet" href="/css/customstyles.css">
<link rel="stylesheet" href="/css/boxshadowproperties.css">

<!-- Most color styles are extracted out to here -->
<link rel="stylesheet" href="/css/theme-blue.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>

<script src="/js/jquery.navgoco.min.js"></script>


<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<!-- Anchor.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.0/anchor.min.js"></script>
<!-- MathJax.js -->
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<script src="/js/toc.js"></script>
<script src="/js/customscripts.js"></script>

<link rel="shortcut icon" href="/images/favicon.ico">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link rel="alternate" type="application/rss+xml" title="" href="http://localhost:4000/feed.xml">

    <script>
        $(document).ready(function() {
            // Initialize navgoco with default options
            $("#mysidebar").navgoco({
                caretHtml: '',
                accordion: true,
                openClass: 'active', // open
                save: false, // leave false or nav highlighting doesn't work right
                cookie: {
                    name: 'navgoco',
                    expires: false,
                    path: '/'
                },
                slide: {
                    duration: 400,
                    easing: 'swing'
                }
            });

            $("#collapseAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', false);
            });

            $("#expandAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', true);
            });

        });

    </script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
    <script>
        $(document).ready(function() {
            $("#tg-sb-link").click(function() {
                $("#tg-sb-sidebar").toggle();
                $("#tg-sb-content").toggleClass('col-md-9');
                $("#tg-sb-content").toggleClass('col-md-12');
                $("#tg-sb-icon").toggleClass('fa-toggle-on');
                $("#tg-sb-icon").toggleClass('fa-toggle-off');
            });
        });
    </script>
    

</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-inverse navbar-static-top">
    <div class="container topnavlinks">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="fa fa-home fa-lg navbar-brand" href="/">&nbsp;<span class="projectTitle"> Kratos Multiphysics Documentation</span></a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- toggle sidebar button -->
                <li><a id="tg-sb-link" href="#"><i id="tg-sb-icon" class="fa fa-toggle-on"></i> Nav</a></li>
                <!-- entries without drop-downs appear here -->




                
                
                
                <li><a href="https://github.com/KratosMultiphysics/Kratos" target="_blank" rel="noopener">GitHub</a></li>
                
                
                
                <li><a href="news">News</a></li>
                
                
                
                <!-- entries with drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                
                
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Kratos<b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        
                        
                        <li><a href="/pages/Kratos/For_Users/General/Overview.html">For Users</a></li>
                        
                        
                        
                        <li><a href="/pages/Kratos/For_Developers/General/Application-Cases.html">For Developers</a></li>
                        
                        
                        
                        <li><a href="/pages/Kratos/Processes/General/Overview.html">Processes</a></li>
                        
                        
                        
                        <li><a href="/pages/Kratos/Utilities/General/Overview.html">Utilities</a></li>
                        
                        
                        
                        <li><a href="/pages/Kratos/Debugging/General/Checking-memory-usage-with-Valgrind.html">Debugging</a></li>
                        
                        
                        
                        <li><a href="/pages/Kratos/Documentation_Guide/General/Overview.html">Documentation Guide</a></li>
                        
                        
                        
                        <li><a href="/pages/Kratos/Workshops/2019/running_an_example_from_GiD.html">Workshops</a></li>
                        
                        
                    </ul>
                </li>
                
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Applications<b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        
                        
                        <li><a href="/pages/Applications/Discrete_Element_Modelling_Application/General/Basic-DEM-Benchmarking.html">Discrete Element Modelling Application</a></li>
                        
                        
                        
                        <li><a href="/pages/Applications/Fluid-Structure_Interaction_Application/General/2D-Mok-benchmark.html">Fluid-Structure Interaction Application</a></li>
                        
                        
                        
                        <li><a href="/pages/Applications/Fluid_Dynamics_Application/General/2D-Cavity-flow-problem.html">Fluid Dynamics Application</a></li>
                        
                        
                        
                        <li><a href="/pages/Applications/Mapping_Application/General/How-to-do-Mapping-between-nonmatching-meshes.html">Mapping Application</a></li>
                        
                        
                        
                        <li><a href="/pages/Applications/Meshing_Application/General/Utilities-MMG-Process.html">Meshing Application</a></li>
                        
                        
                        
                        <li><a href="/pages/Applications/Particle_Mechanics_Application/General/Overview.html">Particle Mechanics Application</a></li>
                        
                        
                        
                        <li><a href="/pages/Applications/Reduced_Order_Modelling_Application/General/API-for-RomApplication-(draft-to-be-moved-elsewhere).html">Reduced Order Modelling Application</a></li>
                        
                        
                        
                        <li><a href="/pages/Applications/Statistics_Application/General/Overview.html">Statistics Application</a></li>
                        
                        
                        
                        <li><a href="/pages/Applications/Structural_Mechanics_Application/General/0_Roll-up-beam-cantilever.html">Structural Mechanics Application</a></li>
                        
                        
                    </ul>
                </li>
                
                
                
                
                
			<li>



  <a class="email" title="Submit feedback" href="#" onclick="javascript:window.location='mailto:kratosmultiphysics@gmail.com?subject=Kratos Multiphysics Documentation feedback&body=I have some feedback about the Implementing thermal solver page: ' + window.location.href;"><i class="fa fa-envelope-o"></i> Feedback</a>

</li>

		
                <!--comment out this block if you want to hide search-->
                <li>
                    <!--start search-->
                    <div id="search-demo-container">
                        <input type="text" id="search-input" placeholder="">
                        <ul id="results-container"></ul>
                    </div>
                    <script src="/js/jekyll-search.js" type="text/javascript"></script>
                    <script type="text/javascript">
                            SimpleJekyllSearch.init({
                                searchInput: document.getElementById('search-input'),
                                resultsContainer: document.getElementById('results-container'),
                                dataSource: '/search.json',
                                searchResultTemplate: '<li><a href="{url}" title="Implementing thermal solver">{title}</a></li>',
                    noResultsText: '',
                            limit: 10,
                            fuzzy: true,
                    })
                    </script>
                    <!--end search-->
                </li>
            </ul>
        </div>
        </div>
        <!-- /.container -->
</nav>

<!-- Page Content -->
<div class="container">
  <div id="main">
    <!-- Content Row -->
    <div class="row">
        
        
            <!-- Sidebar Column -->
            <div class="col-md-3" id="tg-sb-sidebar">
                

<ul id="mysidebar" class="nav">
  <li class="sidebarTitle">For Users </li>
  
  
  
  <li>
      <a title="General" href="#">General</a>
      <ul>
          
          
          
          <li><a title="Summary" href="/pages/Kratos/For_Users/General/../../../index.html">Summary</a></li>
          
          
          
          
          
          
          <li><a title="Overview" href="/pages/Kratos/For_Users/General/Overview.html">Overview</a></li>
          
          
          
          
          
          
          <li><a title="Management Structure" href="/pages/Kratos/For_Users/General/Management_Structure.html">Management Structure</a></li>
          
          
          
          
          
          
          <li><a title="General Structure" href="/pages/Kratos/For_Users/General/General_Structure.html">General Structure</a></li>
          
          
          
          
          
          
          <li><a title="Copyright and Licence" href="/pages/Kratos/For_Users/General/Copyright_and_Licence.html">Copyright and Licence</a></li>
          
          
          
          
      </ul>
  </li>
  
  
  
  <li>
      <a title="How to get Kratos" href="#">How to get Kratos</a>
      <ul>
          
          
          
          <li><a title="" href=""></a></li>
          
          
          
          <li class="subfolders">
              <a title="Binaries" href="#">Binaries</a>
              <ul>
                  
                  
                  
                  <li><a title="Getting Kratos binaries (via GiD)" href="/pages/Kratos/For_Users/How_to_get_Kratos/Binaries/Getting-Kratos-binaries-with-gid.html">Getting Kratos binaries (via GiD)</a></li>
                  
                  
                  
                  
                  
                  <li><a title="Getting Kratos Binaries for Windows" href="/pages/Kratos/For_Users/How_to_get_Kratos/Binaries/Getting-Kratos-Binaries-for-Windows.html">Getting Kratos Binaries for Windows</a></li>
                  
                  
                  
                  
                  
                  <li><a title="Getting Kratos Binaries for Linux" href="/pages/Kratos/For_Users/How_to_get_Kratos/Binaries/Getting-Kratos-Binaries-for-Linux.html">Getting Kratos Binaries for Linux</a></li>
                  
                  
                  
              </ul>
          </li>
          
          
          
          <li class="subfolders">
              <a title="Compilation" href="#">Compilation</a>
              <ul>
                  
                  
                  
                  <li><a title="Compilation Options" href="/pages/Kratos/For_Users/How_to_get_Kratos/Compilation/remote_Compilation_Options.html">Compilation Options</a></li>
                  
                  
                  
                  
                  
                  <li><a title="How to Compile Kratos in Debug mode" href="/pages/Kratos/For_Users/How_to_get_Kratos/Compilation/How-to-Compile-Kratos-in-Debug-mode.html">How to Compile Kratos in Debug mode</a></li>
                  
                  
                  
                  
                  
                  <li><a title="Linux Build" href="/pages/Kratos/For_Users/How_to_get_Kratos/Compilation/Linux-Build.html">Linux Build</a></li>
                  
                  
                  
              </ul>
          </li>
          
          
          
          
      </ul>
  </li>
  
  
  
  <li>
      <a title="Getting started" href="#">Getting started</a>
      <ul>
          
          
          
          <li><a title="Kernel and Applications" href="/pages/Kratos/For_Users/Getting_started/Editing-kratos-kernel-and-application-approach.html">Kernel and Applications</a></li>
          
          
          
          
          
          
          <li><a title="Python Script  Getting Started" href="/pages/Kratos/For_Users/Getting_started/getting-started.html">Python Script  Getting Started</a></li>
          
          
          
          
          
          
          <li><a title="Python Script  Hello Kratos" href="/pages/Kratos/For_Users/Getting_started/hello-world.html">Python Script  Hello Kratos</a></li>
          
          
          
          
          
          
          <li><a title="Python Tutorials" href="/pages/Kratos/For_Users/Getting_started/tutorials.html">Python Tutorials</a></li>
          
          
          
          <li class="subfolders">
              <a title="Data Structure" href="#">Data Structure</a>
              <ul>
                  
                  
                  
                  <li><a title="Entities creation from scratch" href="/pages/Kratos/For_Users/Getting_started/Data_Structure/Entities-creation-from-scratch.html">Entities creation from scratch</a></li>
                  
                  
                  
                  
                  
                  <li><a title="Python Script  Generating New Modelparts" href="/pages/Kratos/For_Users/Getting_started/Data_Structure/generate-new-modelpart.html">Python Script  Generating New Modelparts</a></li>
                  
                  
                  
                  
                  
                  <li><a title="Python Script  ModelPart Elements and Conditions" href="/pages/Kratos/For_Users/Getting_started/Data_Structure/elems-and-conds.html">Python Script  ModelPart Elements and Conditions</a></li>
                  
                  
                  
                  
                  
                  <li><a title="Python Script  ModelPart and SubModelPart" href="/pages/Kratos/For_Users/Getting_started/Data_Structure/modelpart-and-submodelpart.html">Python Script  ModelPart and SubModelPart</a></li>
                  
                  
                  
                  
                  
                  <li><a title="Python Script  Nodes and Nodal Data" href="/pages/Kratos/For_Users/Getting_started/Data_Structure/nodes-and-data.html">Python Script  Nodes and Nodal Data</a></li>
                  
                  
                  
              </ul>
          </li>
          
          
          
          <li class="subfolders">
              <a title="From scratch" href="#">From scratch</a>
              <ul>
                  
                  
                  
                  <li><a title="Creating a base application" href="/pages/Kratos/For_Users/Getting_started/From_scratch/Creating-a-base-application.html">Creating a base application</a></li>
                  
                  
                  
                  
                  
                  <li><a title="Example A simple Fluid   Thermal coupled solver" href="/pages/Kratos/For_Users/Getting_started/From_scratch/Example-A-simple-Fluid---Thermal-coupled-solver.html">Example A simple Fluid   Thermal coupled solver</a></li>
                  
                  
                  
                  
                  
                  <li><a title="How to Create a New Application using cmake" href="/pages/Kratos/For_Users/Getting_started/From_scratch/How-to-Create-a-New-Application-using-cmake.html">How to Create a New Application using cmake</a></li>
                  
                  
                  
                  
                  
                  <li class="active"><a title="Implementing thermal solver" href="/pages/Kratos/For_Users/Getting_started/From_scratch/Implementing-thermal-solver.html">Implementing thermal solver</a></li>
                  
                  
                  
                  
                  
                  <li><a title="Kratos For Dummies Stationary heat transfer" href="/pages/Kratos/For_Users/Getting_started/From_scratch/Kratos-For-Dummies-Stationary-heat-transfer.html">Kratos For Dummies Stationary heat transfer</a></li>
                  
                  
                  
                  
                  
                  <li><a title="Kratos For Dummies Transient non linear heat transfer" href="/pages/Kratos/For_Users/Getting_started/From_scratch/Kratos-For-Dummies-Transient-non-linear-heat-transfer.html">Kratos For Dummies Transient non linear heat transfer</a></li>
                  
                  
                  
              </ul>
          </li>
          
          
          
          <li class="subfolders">
              <a title="Input Output and Visualization" href="#">Input Output and Visualization</a>
              <ul>
                  
                  
                  
                  <li><a title="How to interact with a simulation to visualize real time results" href="/pages/Kratos/For_Users/Getting_started/Input_Output_and_Visualization/How-to-interact-with-a-simulation-to-visualize-real-time-results.html">How to interact with a simulation to visualize real time results</a></li>
                  
                  
                  
                  
                  
                  <li><a title="How to write a JSON configuration file" href="/pages/Kratos/For_Users/Getting_started/Input_Output_and_Visualization/How-to-write-a-JSON-configuration-file.html">How to write a JSON configuration file</a></li>
                  
                  
                  
                  
                  
                  <li><a title="Input data" href="/pages/Kratos/For_Users/Getting_started/Input_Output_and_Visualization/Input-data.html">Input data</a></li>
                  
                  
                  
                  
                  
                  <li><a title="Python Script  Reading ModelPart From Input File" href="/pages/Kratos/For_Users/Getting_started/Input_Output_and_Visualization/reading-input.html">Python Script  Reading ModelPart From Input File</a></li>
                  
                  
                  
                  
                  
                  <li><a title="Python Script  Reading ProjectParameters" href="/pages/Kratos/For_Users/Getting_started/Input_Output_and_Visualization/project-parameters.html">Python Script  Reading ProjectParameters</a></li>
                  
                  
                  
                  
                  
                  <li><a title="Python Script  Writing Output File" href="/pages/Kratos/For_Users/Getting_started/Input_Output_and_Visualization/writing-output.html">Python Script  Writing Output File</a></li>
                  
                  
                  
              </ul>
          </li>
          
          
          
          
      </ul>
  </li>
  
  
  
      <!-- if you aren't using the accordion, uncomment this block:
         <p class="external">
             <a href="#" id="collapseAll">Collapse All</a> | <a href="#" id="expandAll">Expand All</a>
         </p>
         -->
</ul>

<!-- this highlights the active parent class in the navgoco sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above. Otherwise, if placed inside customscripts.js, the script runs before the sidebar code runs and the class never gets inserted.-->
<script>$("li.active").parents('li').toggleClass("active");</script>

            </div>
            
        

        <!-- Content Column -->
        <div class="col-md-9" id="tg-sb-content">
            <div class="post-header">
   <h1 class="post-title-main">Implementing thermal solver</h1>
</div>



<div class="post-content">

   

    
    
<!-- this handles the automatic toc. use ## for subheads to auto-generate the on-page minitoc. if you use html tags, you must supply an ID for the heading element in order for it to appear in the minitoc. -->
<script>
$( document ).ready(function() {
  // Handler for .ready() called.

$('#toc').toc({ minimumHeaders: 0, listType: 'ul', showSpeed: 0, headers: 'h2,h3,h4' });

/* this offset helps account for the space taken up by the floating toolbar. */
$('#toc').on('click', 'a', function() {
  var target = $(this.getAttribute('href'))
    , scroll_target = target.offset().top

  $(window).scrollTop(scroll_target - 10);
  return false
})
  
});
</script>

<div id="toc"></div>

    


    

    <a target="_blank" rel="noopener" href="https://github.com/KratosMultiphysics/Kratos/tree/master/docs/pages/Kratos/For_Users/Getting_started/From_scratch/Implementing-thermal-solver.md" class="btn btn-default githubEditButton" role="button"><i class="fa fa-github fa-lg"></i> Edit me</a>

    

   <p>The following tutorial will explain how to <strong>implement a <code class="language-plaintext highlighter-rouge">Solver</code> from scratch</strong>, in this case applied to the particular case of the <em>thermal problem</em>, following the lines of the already presented on the other tutorials. We will skip the most advanced points of the construction of the <code class="language-plaintext highlighter-rouge">Solver</code> and we will create a <strong>basic working solver</strong> for the sake of academic purposes, so the resulting file will not coincide with the real solver on the <a href="https://github.com/KratosMultiphysics/Kratos/blob/Release-6.0/applications/convection_diffusion_application/python_scripts/convection_diffusion_base_solver.py">repository</a>.</p>

<h1 id="imports">Imports</h1>

<p>The solver as any element of <em>Kratos</em> requires to import the corresponding libraries and applications. Like out objective on mind is to create a thermal problem, we will import the base <code class="language-plaintext highlighter-rouge">KratosMultiphysics</code> library as well as the <code class="language-plaintext highlighter-rouge">ConvectionDiffusionApplication</code>. For importing files from the filesystem we will import <code class="language-plaintext highlighter-rouge">os</code> <em>python</em> library, which will be helpful.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span>  <span class="c1"># makes KratosMultiphysics backward compatible with python 2.6 and 2.7
</span>
<span class="c1"># Importing the Kratos Library
</span><span class="kn">import</span> <span class="nn">KratosMultiphysics</span>

<span class="c1"># Import applications
</span><span class="kn">import</span> <span class="nn">KratosMultiphysics.ConvectionDiffusionApplication</span> <span class="k">as</span> <span class="n">ConvectionDiffusionApplication</span>

<span class="c1"># Other imports
</span><span class="kn">import</span> <span class="nn">os</span>
</code></pre></div></div>

<h1 id="constructing-the-solver">Constructing the solver</h1>

<p>We will create a <code class="language-plaintext highlighter-rouge">Solver</code>, following was is done in other applications <code class="language-plaintext highlighter-rouge">Solver</code>, for the sake of consistency, so in first place we define the function <code class="language-plaintext highlighter-rouge">CreateSolver</code>, which is common among all the solvers and therefore it is necessary to be called that way. This function will use as input a <code class="language-plaintext highlighter-rouge">Model</code> and configuration <code class="language-plaintext highlighter-rouge">Parameters</code>:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">CreateSolver</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">custom_settings</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ConvectionDiffusionSolver</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">custom_settings</span><span class="p">)</span>
</code></pre></div></div>

<p>As we see this function call a class called <code class="language-plaintext highlighter-rouge">ConvectionDiffusionSolver</code>, so we need to define our solver in first place, for that we define the constructor or <code class="language-plaintext highlighter-rouge">__init__</code> function:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ConvectionDiffusionSolver</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="s">"""The base class for convection-diffusion solvers.
    This class provides functions for importing and exporting models,
    adding nodal variables and dofs and solving each solution step.
    """</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">custom_settings</span><span class="p">):</span>
        <span class="n">default_settings</span> <span class="o">=</span> <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">Parameters</span><span class="p">(</span><span class="s">"""
        {
            "model_part_name" : "ThermalModelPart",
            "echo_level": 0,
            "buffer_size": 2,
            "model_import_settings": {
                "input_type": "mdpa",
                "input_filename": "unknown_name"
            },
            "computing_model_part_name" : "Thermal",
            "material_import_settings" :{
                "materials_filename": ""
            },
            "clear_storage": false,
            "residual_relative_tolerance": 1.0e-4,
            "residual_absolute_tolerance": 1.0e-9,
            "max_iteration": 10,
            "linear_solver_settings":{
                "solver_type": "BICGSTABSolver",
                "preconditioner_type": "DiagonalPreconditioner",
                "max_iteration": 5000,
                "tolerance": 1e-9,
                "scaling": false
            },
            "element_replace_settings" : {
                "element_name" : "EulerianConvDiff",
                "condition_name" : "Condition"
            },
            "problem_domain_sub_model_part_list": ["conv_diff_body"],
            "processes_sub_model_part_list": [""]
        }
        """</span><span class="p">)</span>
    
        <span class="c1"># Overwrite the default settings with user-provided parameters.
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">custom_settings</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">.</span><span class="n">ValidateAndAssignDefaults</span><span class="p">(</span><span class="n">default_settings</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">model_part_name</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">"model_part_name"</span><span class="p">].</span><span class="n">GetString</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">model</span><span class="p">[</span><span class="n">model_part_name</span><span class="p">]</span>
        <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">Logger</span><span class="p">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s">"::[ConvectionDiffusionSolver]:: "</span><span class="p">,</span> <span class="s">"Construction finished"</span><span class="p">)</span>
</code></pre></div></div>

<p>First we define the default <code class="language-plaintext highlighter-rouge">Parameters</code>, which will overwrite the not define configurations of our <code class="language-plaintext highlighter-rouge">custom_settings</code>, this is done with the <code class="language-plaintext highlighter-rouge">ValidateAndAssignDefaults</code> method. We define the <code class="language-plaintext highlighter-rouge">main_model_part</code> as a part of the solver, using the <code class="language-plaintext highlighter-rouge">self</code> to define it as an instance attribute.</p>

<h1 id="common-methods-for-the-solver">Common methods for the solver</h1>

<p>The following are common methods defined in all solvers in order to have an interoperability between them to couple different physical problems.</p>

<h2 id="add-variables">Add variables</h2>

<p>The <code class="language-plaintext highlighter-rouge">AddVariables</code> is the liable on adding the nodal historical variables to the model part. We will need to define a buffer in order to be able to access this historical variables. We will see how in following sections.</p>

<p>We add the variables corresponding to the standard thermal convection-diffusion problem. We will need to add this variables to the <code class="language-plaintext highlighter-rouge">CONVECTION_DIFFUSION_SETTINGS</code> (this is something specific of the <code class="language-plaintext highlighter-rouge">ConvectionDiffusionAplication</code>, and is done in order to solve different types convection diffusion problems).</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">AddVariables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s">''' Add nodal solution step variables ( later add to CONVECTION_DIFFUSION_SETTINGS)
    '''</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">AddNodalSolutionStepVariable</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">DENSITY</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">AddNodalSolutionStepVariable</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">CONDUCTIVITY</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">AddNodalSolutionStepVariable</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">TEMPERATURE</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">AddNodalSolutionStepVariable</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">HEAT_FLUX</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">AddNodalSolutionStepVariable</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">FACE_HEAT_FLUX</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">AddNodalSolutionStepVariable</span><span class="p">(</span><span class="n">ConvectionDiffusionApplication</span><span class="p">.</span><span class="n">PROJECTED_SCALAR1</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">AddNodalSolutionStepVariable</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">CONVECTION_VELOCITY</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">AddNodalSolutionStepVariable</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">MESH_VELOCITY</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">AddNodalSolutionStepVariable</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">VELOCITY</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">AddNodalSolutionStepVariable</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">SPECIFIC_HEAT</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">AddNodalSolutionStepVariable</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">REACTION_FLUX</span><span class="p">)</span>

    <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">Logger</span><span class="p">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s">"::[ConvectionDiffusionBaseSolver]:: "</span><span class="p">,</span> <span class="s">"Variables ADDED"</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="add-dofs">Add DoFs</h2>

<p>In this case we add to the nodes the degrees of freedom corresponding to the problems we want to solve, in our case only the <code class="language-plaintext highlighter-rouge">TEMPERATURE</code>.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">AddDofs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">VariableUtils</span><span class="p">().</span><span class="n">AddDof</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">TEMPERATURE</span><span class="p">,</span> <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">REACTION_FLUX</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">)</span>
    <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">Logger</span><span class="p">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s">"::[ConvectionDiffusionBaseSolver]:: "</span><span class="p">,</span> <span class="s">"DOF's ADDED"</span><span class="p">)</span>
</code></pre></div></div>

<p>We the <code class="language-plaintext highlighter-rouge">VariableUtils</code> class, which allows us to do this operation in parallel, in case we want to use the methods available directly on the <code class="language-plaintext highlighter-rouge">Node</code> class we can do:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">AddDofs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">Nodes</span><span class="p">:</span>
        <span class="n">node</span><span class="p">.</span><span class="n">AddDof</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">TEMPERATURE</span><span class="p">,</span> <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">REACTION_FLUX</span><span class="p">)</span>          
    <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">Logger</span><span class="p">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s">"::[ConvectionDiffusionBaseSolver]:: "</span><span class="p">,</span> <span class="s">"DOF's ADDED"</span><span class="p">)</span>  
</code></pre></div></div>

<h2 id="read-external-file-mdpa-file">Read external file (<code class="language-plaintext highlighter-rouge">*.mdpa</code> file)</h2>

<p>We read the <code class="language-plaintext highlighter-rouge">*.mdpa</code> file for that we use the class <code class="language-plaintext highlighter-rouge">ModelPartIO</code>, which is the class in charge of managing the write/read procedures.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">ReadModelPart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">Logger</span><span class="p">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s">"::[ConvectionDiffusionBaseSolver]::"</span><span class="p">,</span> <span class="s">"Reading model part."</span><span class="p">)</span>
    <span class="n">problem_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="n">input_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">"model_import_settings"</span><span class="p">][</span><span class="s">"input_filename"</span><span class="p">].</span><span class="n">GetString</span><span class="p">()</span>
    <span class="c1"># Import model part from mdpa file.
</span>    <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">ModelPartIO</span><span class="p">(</span><span class="n">input_filename</span><span class="p">).</span><span class="n">ReadModelPart</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">)</span>
    <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">Logger</span><span class="p">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s">"ModelPart"</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">)</span>
    <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">Logger</span><span class="p">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s">"::[ConvectionDiffusionBaseSolver]:: "</span><span class="p">,</span> <span class="s">"Finished reading model part."</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="prepare-model-part">Prepare model part</h2>

<p>After reading the model part we need to do some operations, as checking the mesh orientation, assigning the physical elements and conditions to the <em>dummy</em> <code class="language-plaintext highlighter-rouge">Element</code>/<code class="language-plaintext highlighter-rouge">Condition</code> and filling the buffer.</p>

<p>We mean for <em>dummy</em> ` Condition<code class="language-plaintext highlighter-rouge"> and </code>Element` that only contain a geometry and donâ€™t solve any physical problem, this is done for the sake of interoperability, which allows us to use the same mesh for the fluid and thermal problem.</p>

<p>First we define the reading of the properties of the problem. We use the  <code class="language-plaintext highlighter-rouge">read_materials_process</code> defined on the core of <em>Kratos</em>.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_execute_after_reading</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s">"""Import materials. """</span>
    <span class="n">materials_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">"material_import_settings"</span><span class="p">][</span><span class="s">"materials_filename"</span><span class="p">].</span><span class="n">GetString</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">materials_filename</span> <span class="o">!=</span> <span class="s">""</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">read_materials_process</span>
        <span class="c1"># Create a dictionary of model parts.
</span>        <span class="c1"># Add constitutive laws and material properties from json file to model parts.
</span>        <span class="n">read_materials_process</span><span class="p">.</span><span class="n">ReadMaterialsProcess</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">"material_import_settings"</span><span class="p">])</span>
        
        <span class="c1"># We set the properties that are nodal
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">_assign_nodally_properties</span><span class="p">()</span>
        
        <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">Logger</span><span class="p">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s">"::[ConvectionDiffusionBaseSolver]:: "</span><span class="p">,</span> <span class="s">"Materials were successfully imported."</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">Logger</span><span class="p">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s">"::[ConvectionDiffusionBaseSolver]:: "</span><span class="p">,</span> <span class="s">"Materials were not imported."</span><span class="p">)</span>
</code></pre></div></div>

<p>In the case of the convection diffusion problems, the properties are not read from the <code class="language-plaintext highlighter-rouge">Property</code> but directly from the nodal values, so we create a method in order to copy this properties into the nodes of the mesh:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_assign_nodally_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># We transfer the values of the con.diff variables to the nodes
</span>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">"material_import_settings"</span><span class="p">][</span><span class="s">"materials_filename"</span><span class="p">].</span><span class="n">GetString</span><span class="p">(),</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">parameter_file</span><span class="p">:</span>
        <span class="n">materials</span> <span class="o">=</span> <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">Parameters</span><span class="p">(</span><span class="n">parameter_file</span><span class="p">.</span><span class="n">read</span><span class="p">())</span>
        
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">materials</span><span class="p">[</span><span class="s">"properties"</span><span class="p">].</span><span class="n">size</span><span class="p">()):</span>
        <span class="n">model_part</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">GetSubModelPart</span><span class="p">(</span><span class="n">materials</span><span class="p">[</span><span class="s">"properties"</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s">"model_part_name"</span><span class="p">].</span><span class="n">GetString</span><span class="p">())</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">materials</span><span class="p">[</span><span class="s">"properties"</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s">"Material"</span><span class="p">]</span>
        
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">mat</span><span class="p">[</span><span class="s">"Variables"</span><span class="p">].</span><span class="n">items</span><span class="p">():</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">KratosGlobals</span><span class="p">.</span><span class="n">GetVariable</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">_check_variable_to_set</span><span class="p">(</span><span class="n">var</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">value</span><span class="p">.</span><span class="n">IsDouble</span><span class="p">():</span>
                    <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">VariableUtils</span><span class="p">().</span><span class="n">SetScalarVar</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">.</span><span class="n">GetDouble</span><span class="p">(),</span> <span class="n">model_part</span><span class="p">.</span><span class="n">Nodes</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">value</span><span class="p">.</span><span class="n">IsVector</span><span class="p">():</span>
                    <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">VariableUtils</span><span class="p">().</span><span class="n">SetVectorVar</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">.</span><span class="n">GetVector</span><span class="p">(),</span> <span class="n">model_part</span><span class="p">.</span><span class="n">Nodes</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">"Type of value is not available"</span><span class="p">)</span>
</code></pre></div></div>

<p>We define the <code class="language-plaintext highlighter-rouge">Parameters</code> necessaries for the replace the <code class="language-plaintext highlighter-rouge">Element</code>/<code class="language-plaintext highlighter-rouge">Condition</code>, which depend on the configuration parameters, and the geometry of the problem (2D/3D, triangle, quadrilaterals, etcâ€¦). We will use the class <code class="language-plaintext highlighter-rouge">ReplaceElementsAndConditionsProcess</code> to replace these elements and conditions.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_get_element_condition_replace_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">num_nodes_elements</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">Elements</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">num_nodes_elements</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">Elements</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">GetNodes</span><span class="p">())</span>

    <span class="c1">## Elements
</span>    <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">ProcessInfo</span><span class="p">[</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">DOMAIN_SIZE</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">num_nodes_elements</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">"element_replace_settings"</span><span class="p">][</span><span class="s">"element_name"</span><span class="p">].</span><span class="n">SetString</span><span class="p">(</span><span class="s">"EulerianConvDiff2D"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">"element_replace_settings"</span><span class="p">][</span><span class="s">"element_name"</span><span class="p">].</span><span class="n">SetString</span><span class="p">(</span><span class="s">"EulerianConvDiff2D4N"</span><span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">ProcessInfo</span><span class="p">[</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">DOMAIN_SIZE</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">"element_replace_settings"</span><span class="p">][</span><span class="s">"element_name"</span><span class="p">].</span><span class="n">GetString</span><span class="p">()</span> <span class="o">==</span> <span class="s">"EulerianConvDiff"</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">"element_replace_settings"</span><span class="p">][</span><span class="s">"element_name"</span><span class="p">].</span><span class="n">SetString</span><span class="p">(</span><span class="s">"EulerianConvDiff3D"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="s">"DOMAIN_SIZE not set"</span><span class="p">)</span>
    
    <span class="c1">## Conditions
</span>    <span class="n">num_nodes_conditions</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">Conditions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">num_nodes_conditions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">Conditions</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">GetNodes</span><span class="p">())</span>
    <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">ProcessInfo</span><span class="p">[</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">DOMAIN_SIZE</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">"element_replace_settings"</span><span class="p">][</span><span class="s">"condition_name"</span><span class="p">].</span><span class="n">SetString</span><span class="p">(</span><span class="s">"LineCondition2D2N"</span><span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">ProcessInfo</span><span class="p">[</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">DOMAIN_SIZE</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">"element_replace_settings"</span><span class="p">][</span><span class="s">"condition_name"</span><span class="p">].</span><span class="n">SetString</span><span class="p">(</span><span class="s">"SurfaceCondition3D3N"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="s">"DOMAIN_SIZE not set"</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">"element_replace_settings"</span><span class="p">]</span>
</code></pre></div></div>

<p>Fill the buffer is as easy as:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">_set_and_fill_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s">"""Prepare nodal solution step data containers and time step information. """</span>
    <span class="c1"># Set the buffer size for the nodal solution steps data. Existing nodal
</span>    <span class="c1"># solution step data may be lost.
</span>    <span class="n">required_buffer_size</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">"buffer_size"</span><span class="p">].</span><span class="n">GetInt</span><span class="p">()</span>
    <span class="n">current_buffer_size</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">GetBufferSize</span><span class="p">()</span>
    <span class="n">buffer_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">current_buffer_size</span><span class="p">,</span> <span class="n">required_buffer_size</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">SetBufferSize</span><span class="p">(</span><span class="n">buffer_size</span><span class="p">)</span>
    <span class="c1"># Cycle the buffer. This sets all historical nodal solution step data to
</span>    <span class="c1"># the current value and initializes the time stepping in the process info.
</span>    <span class="n">delta_time</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">ProcessInfo</span><span class="p">[</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">DELTA_TIME</span><span class="p">]</span>
    <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">ProcessInfo</span><span class="p">[</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">TIME</span><span class="p">]</span>
    <span class="n">step</span> <span class="o">=-</span><span class="n">buffer_size</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">time</span> <span class="o">-</span> <span class="n">delta_time</span> <span class="o">*</span> <span class="n">buffer_size</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">ProcessInfo</span><span class="p">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">TIME</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">):</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">step</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">time</span> <span class="o">+</span> <span class="n">delta_time</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">ProcessInfo</span><span class="p">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">STEP</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">CloneTimeStep</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
</code></pre></div></div>

<p>Finally, now that we have all the tools to prepare the model part we can define the method:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">PrepareModelPartForSolver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
    <span class="c1"># Check and prepare computing model part and import constitutive laws.
</span>    <span class="bp">self</span><span class="p">.</span><span class="n">_execute_after_reading</span><span class="p">()</span>

    <span class="n">throw_errors</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">TetrahedralMeshOrientationCheck</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">,</span> <span class="n">throw_errors</span><span class="p">).</span><span class="n">Execute</span><span class="p">()</span>
    <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">ReplaceElementsAndConditionsProcess</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">,</span><span class="bp">self</span><span class="p">.</span><span class="n">_get_element_condition_replace_settings</span><span class="p">()).</span><span class="n">Execute</span><span class="p">()</span>

    <span class="bp">self</span><span class="p">.</span><span class="n">_set_and_fill_buffer</span><span class="p">()</span>
    
    <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">Logger</span><span class="p">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s">"::[ConvectionDiffusionBaseSolver]::"</span><span class="p">,</span> <span class="s">"ModelPart prepared for Solver."</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="initialize-method">Initialize method</h2>

<p>In order to initialize the solver we need to create the strategy, which will be <em>Newton-Raphson</em> in our case
. Additionally we will define the <code class="language-plaintext highlighter-rouge">CONVECTION_DIFFUSION_SETTINGS</code> which can be used by the elements and conditions from the application.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">Initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s">"""Perform initialization after adding nodal variables and dofs to the main model part. """</span>
    <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">Logger</span><span class="p">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s">"::[ConvectionDiffusionBaseSolver]:: "</span><span class="p">,</span> <span class="s">"Initializing ..."</span><span class="p">)</span>

    <span class="c1"># We define the convection diffusion settings
</span>    <span class="n">convention_diffusion_settings</span> <span class="o">=</span> <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">ConvectionDiffusionSettings</span><span class="p">()</span>
    <span class="n">convention_diffusion_settings</span><span class="p">.</span><span class="n">SetDensityVariable</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">DENSITY</span><span class="p">)</span>
    <span class="n">convention_diffusion_settings</span><span class="p">.</span><span class="n">SetDiffusionVariable</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">CONDUCTIVITY</span><span class="p">)</span>
    <span class="n">convention_diffusion_settings</span><span class="p">.</span><span class="n">SetUnknownVariable</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">TEMPERATURE</span><span class="p">)</span>
    <span class="n">convention_diffusion_settings</span><span class="p">.</span><span class="n">SetVolumeSourceVariable</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">HEAT_FLUX</span><span class="p">)</span>
    <span class="n">convention_diffusion_settings</span><span class="p">.</span><span class="n">SetSurfaceSourceVariable</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">FACE_HEAT_FLUX</span><span class="p">)</span>
    <span class="n">convention_diffusion_settings</span><span class="p">.</span><span class="n">SetProjectionVariable</span><span class="p">(</span><span class="n">ConvectionDiffusionApplication</span><span class="p">.</span><span class="n">PROJECTED_SCALAR1</span><span class="p">)</span>
    <span class="n">convention_diffusion_settings</span><span class="p">.</span><span class="n">SetConvectionVariable</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">CONVECTION_VELOCITY</span><span class="p">)</span>
    <span class="n">convention_diffusion_settings</span><span class="p">.</span><span class="n">SetMeshVelocityVariable</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">MESH_VELOCITY</span><span class="p">)</span>
    <span class="n">convention_diffusion_settings</span><span class="p">.</span><span class="n">SetVelocityVariable</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">VELOCITY</span><span class="p">)</span>
    <span class="n">convention_diffusion_settings</span><span class="p">.</span><span class="n">SetSpecificHeatVariable</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">SPECIFIC_HEAT</span><span class="p">)</span>
    <span class="n">convention_diffusion_settings</span><span class="p">.</span><span class="n">SetReactionVariable</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">REACTION_FLUX</span><span class="p">)</span>
        
    <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">ProcessInfo</span><span class="p">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">CONVECTION_DIFFUSION_SETTINGS</span><span class="p">,</span> <span class="n">convention_diffusion_settings</span><span class="p">)</span>
        
    <span class="c1"># The mechanical solution strategy is created here if it does not already exist.
</span>    <span class="n">computing_model_part</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span> <span class="c1"># We will use the main model part
</span>    <span class="c1">#Variable defining the temporal scheme (0: Forward Euler, 1: Backward Euler, 0.5: Crank-Nicolson)
</span>    <span class="n">computing_model_part</span><span class="p">.</span><span class="n">ProcessInfo</span><span class="p">[</span><span class="n">ConvectionDiffusionApplication</span><span class="p">.</span><span class="n">THETA</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">computing_model_part</span><span class="p">.</span><span class="n">ProcessInfo</span><span class="p">[</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">DYNAMIC_TAU</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">conv_diff_scheme</span> <span class="o">=</span> <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">ResidualBasedIncrementalUpdateStaticScheme</span><span class="p">()</span>
    <span class="kn">import</span> <span class="nn">linear_solver_factory</span>
    <span class="n">linear_solver</span> <span class="o">=</span> <span class="n">linear_solver_factory</span><span class="p">.</span><span class="n">ConstructSolver</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">"linear_solver_settings"</span><span class="p">])</span>
    <span class="n">conv_diff_convergence_criterion</span> <span class="o">=</span> <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">ResidualCriteria</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">"residual_relative_tolerance"</span><span class="p">].</span><span class="n">GetDouble</span><span class="p">(),</span> <span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">"residual_absolute_tolerance"</span><span class="p">].</span><span class="n">GetDouble</span><span class="p">())</span>
    <span class="n">builder_and_solver</span> <span class="o">=</span> <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">ResidualBasedBlockBuilderAndSolver</span><span class="p">(</span><span class="n">linear_solver</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">conv_diff_strategy</span> <span class="o">=</span> <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">ResidualBasedNewtonRaphsonStrategy</span><span class="p">(</span><span class="n">computing_model_part</span><span class="p">,</span>  <span class="n">conv_diff_scheme</span><span class="p">,</span> <span class="n">linear_solver</span><span class="p">,</span> <span class="n">conv_diff_convergence_criterion</span><span class="p">,</span> <span class="n">builder_and_solver</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">"max_iteration"</span><span class="p">].</span><span class="n">GetInt</span><span class="p">(),</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">conv_diff_strategy</span><span class="p">.</span><span class="n">SetEchoLevel</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">"echo_level"</span><span class="p">].</span><span class="n">GetInt</span><span class="p">())</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">conv_diff_strategy</span><span class="p">.</span><span class="n">Initialize</span><span class="p">()</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">conv_diff_strategy</span><span class="p">.</span><span class="n">Check</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">"clear_storage"</span><span class="p">].</span><span class="n">GetBool</span><span class="p">():</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">conv_diff_strategy</span><span class="p">.</span><span class="n">Clear</span><span class="p">()</span>
    <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">Logger</span><span class="p">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s">"::[ConvectionDiffusionBaseSolver]:: "</span><span class="p">,</span> <span class="s">"Finished initialization."</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="solving-methods">Solving methods</h2>

<p>The <code class="language-plaintext highlighter-rouge">Solver</code> as well as the strategy, has the same solving steps as the strategies (<em>Newton-Rapshon</em> and so on), this methods are <code class="language-plaintext highlighter-rouge">InitializeSolutionStep</code>, <code class="language-plaintext highlighter-rouge">Predict</code>, <code class="language-plaintext highlighter-rouge">SolveSolutionStep</code> and <code class="language-plaintext highlighter-rouge">FinalizeSolutionStep</code>, which can be call all together in only one method <code class="language-plaintext highlighter-rouge">Solve</code>.</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">Solve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">"clear_storage"</span><span class="p">].</span><span class="n">GetBool</span><span class="p">():</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">conv_diff_strategy</span><span class="p">.</span><span class="n">Clear</span><span class="p">()</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">conv_diff_strategy</span><span class="p">.</span><span class="n">Solve</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">InitializeSolutionStep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">conv_diff_strategy</span><span class="p">.</span><span class="n">InitializeSolutionStep</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">Predict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">conv_diff_strategy</span><span class="p">.</span><span class="n">Predict</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">SolveSolutionStep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">is_converged</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">conv_diff_strategy</span><span class="p">.</span><span class="n">SolveSolutionStep</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">is_converged</span>

<span class="k">def</span> <span class="nf">FinalizeSolutionStep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">conv_diff_strategy</span><span class="p">.</span><span class="n">FinalizeSolutionStep</span><span class="p">()</span>
</code></pre></div></div>

<h1 id="final-script">Final script</h1>

<p>Our thermal solver will be like the following:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span>  <span class="c1"># makes KratosMultiphysics backward compatible with python 2.6 and 2.7
</span>
<span class="c1"># Importing the Kratos Library
</span><span class="kn">import</span> <span class="nn">KratosMultiphysics</span>

<span class="c1"># Import applications
</span><span class="kn">import</span> <span class="nn">KratosMultiphysics.ConvectionDiffusionApplication</span> <span class="k">as</span> <span class="n">ConvectionDiffusionApplication</span>

<span class="c1"># Other imports
</span><span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">CreateSolver</span><span class="p">(</span><span class="n">main_model_part</span><span class="p">,</span> <span class="n">custom_settings</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ConvectionDiffusionSolver</span><span class="p">(</span><span class="n">main_model_part</span><span class="p">,</span> <span class="n">custom_settings</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ConvectionDiffusionSolver</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="s">"""The base class for convection-diffusion solvers.
    This class provides functions for importing and exporting models,
    adding nodal variables and dofs and solving each solution step.
    """</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">custom_settings</span><span class="p">):</span>
        <span class="n">default_settings</span> <span class="o">=</span> <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">Parameters</span><span class="p">(</span><span class="s">"""
        {
            "model_part_name" : "ThermalModelPart",
            "echo_level": 0,
            "buffer_size": 2,
            "model_import_settings": {
                "input_type": "mdpa",
                "input_filename": "unknown_name"
            },
            "computing_model_part_name" : "Thermal",
            "material_import_settings" :{
                "materials_filename": ""
            },
            "clear_storage": false,
            "residual_relative_tolerance": 1.0e-4,
            "residual_absolute_tolerance": 1.0e-9,
            "max_iteration": 10,
            "linear_solver_settings":{
                "solver_type": "BICGSTABSolver",
                "preconditioner_type": "DiagonalPreconditioner",
                "max_iteration": 5000,
                "tolerance": 1e-9,
                "scaling": false
            },
            "element_replace_settings" : {
                "element_name" : "EulerianConvDiff",
                "condition_name" : "Condition"
            },
            "problem_domain_sub_model_part_list": ["conv_diff_body"],
            "processes_sub_model_part_list": [""]
        }
        """</span><span class="p">)</span>
    
        <span class="c1"># Overwrite the default settings with user-provided parameters.
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">custom_settings</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">.</span><span class="n">ValidateAndAssignDefaults</span><span class="p">(</span><span class="n">default_settings</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">model_part_name</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">"model_part_name"</span><span class="p">].</span><span class="n">GetString</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">model</span><span class="p">[</span><span class="n">model_part_name</span><span class="p">]</span>
        <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">Logger</span><span class="p">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s">"::[ConvectionDiffusionSolver]:: "</span><span class="p">,</span> <span class="s">"Construction finished"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">AddVariables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">''' Add nodal solution step variables ( later add to CONVECTION_DIFFUSION_SETTINGS)
        '''</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">AddNodalSolutionStepVariable</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">DENSITY</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">AddNodalSolutionStepVariable</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">CONDUCTIVITY</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">AddNodalSolutionStepVariable</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">TEMPERATURE</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">AddNodalSolutionStepVariable</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">HEAT_FLUX</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">AddNodalSolutionStepVariable</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">FACE_HEAT_FLUX</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">AddNodalSolutionStepVariable</span><span class="p">(</span><span class="n">ConvectionDiffusionApplication</span><span class="p">.</span><span class="n">PROJECTED_SCALAR1</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">AddNodalSolutionStepVariable</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">CONVECTION_VELOCITY</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">AddNodalSolutionStepVariable</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">MESH_VELOCITY</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">AddNodalSolutionStepVariable</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">VELOCITY</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">AddNodalSolutionStepVariable</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">SPECIFIC_HEAT</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">AddNodalSolutionStepVariable</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">REACTION_FLUX</span><span class="p">)</span>

        <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">Logger</span><span class="p">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s">"::[ConvectionDiffusionBaseSolver]:: "</span><span class="p">,</span> <span class="s">"Variables ADDED"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">AddDofs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">Nodes</span><span class="p">:</span>
            <span class="n">node</span><span class="p">.</span><span class="n">AddDof</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">TEMPERATURE</span><span class="p">,</span> <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">REACTION_FLUX</span><span class="p">)</span>          
        <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">Logger</span><span class="p">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s">"::[ConvectionDiffusionBaseSolver]:: "</span><span class="p">,</span> <span class="s">"DOF's ADDED"</span><span class="p">)</span>  

    <span class="k">def</span> <span class="nf">ReadModelPart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">Logger</span><span class="p">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s">"::[ConvectionDiffusionBaseSolver]::"</span><span class="p">,</span> <span class="s">"Reading model part."</span><span class="p">)</span>
        <span class="n">problem_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">input_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">"model_import_settings"</span><span class="p">][</span><span class="s">"input_filename"</span><span class="p">].</span><span class="n">GetString</span><span class="p">()</span>
        <span class="c1"># Import model part from mdpa file.
</span>        <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">ModelPartIO</span><span class="p">(</span><span class="n">input_filename</span><span class="p">).</span><span class="n">ReadModelPart</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">)</span>
        <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">Logger</span><span class="p">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s">"ModelPart"</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">)</span>
        <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">Logger</span><span class="p">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s">"::[ConvectionDiffusionBaseSolver]:: "</span><span class="p">,</span> <span class="s">"Finished reading model part."</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_execute_after_reading</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Import materials. """</span>
        <span class="n">materials_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">"material_import_settings"</span><span class="p">][</span><span class="s">"materials_filename"</span><span class="p">].</span><span class="n">GetString</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">materials_filename</span> <span class="o">!=</span> <span class="s">""</span><span class="p">):</span>
            <span class="kn">import</span> <span class="nn">read_materials_process</span>
            <span class="c1"># Add constitutive laws and material properties from json file to model parts.
</span>            <span class="n">read_materials_process</span><span class="p">.</span><span class="n">ReadMaterialsProcess</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">"material_import_settings"</span><span class="p">])</span>
            
            <span class="c1"># We set the properties that are nodal
</span>            <span class="bp">self</span><span class="p">.</span><span class="n">_assign_nodally_properties</span><span class="p">()</span>
            
            <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">Logger</span><span class="p">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s">"::[ConvectionDiffusionBaseSolver]:: "</span><span class="p">,</span> <span class="s">"Materials were successfully imported."</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">Logger</span><span class="p">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s">"::[ConvectionDiffusionBaseSolver]:: "</span><span class="p">,</span> <span class="s">"Materials were not imported."</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_assign_nodally_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># We transfer the values of the con.diff variables to the nodes
</span>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">"material_import_settings"</span><span class="p">][</span><span class="s">"materials_filename"</span><span class="p">].</span><span class="n">GetString</span><span class="p">(),</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">parameter_file</span><span class="p">:</span>
            <span class="n">materials</span> <span class="o">=</span> <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">Parameters</span><span class="p">(</span><span class="n">parameter_file</span><span class="p">.</span><span class="n">read</span><span class="p">())</span>
            
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">materials</span><span class="p">[</span><span class="s">"properties"</span><span class="p">].</span><span class="n">size</span><span class="p">()):</span>
            <span class="n">model_part</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">GetSubModelPart</span><span class="p">(</span><span class="n">materials</span><span class="p">[</span><span class="s">"properties"</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s">"model_part_name"</span><span class="p">].</span><span class="n">GetString</span><span class="p">())</span>
            <span class="n">mat</span> <span class="o">=</span> <span class="n">materials</span><span class="p">[</span><span class="s">"properties"</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s">"Material"</span><span class="p">]</span>
            
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">mat</span><span class="p">[</span><span class="s">"Variables"</span><span class="p">].</span><span class="n">items</span><span class="p">():</span>
                <span class="n">var</span> <span class="o">=</span> <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">KratosGlobals</span><span class="p">.</span><span class="n">GetVariable</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">_check_variable_to_set</span><span class="p">(</span><span class="n">var</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">value</span><span class="p">.</span><span class="n">IsDouble</span><span class="p">():</span>
                        <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">VariableUtils</span><span class="p">().</span><span class="n">SetScalarVar</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">.</span><span class="n">GetDouble</span><span class="p">(),</span> <span class="n">model_part</span><span class="p">.</span><span class="n">Nodes</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">value</span><span class="p">.</span><span class="n">IsVector</span><span class="p">():</span>
                        <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">VariableUtils</span><span class="p">().</span><span class="n">SetVectorVar</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">.</span><span class="n">GetVector</span><span class="p">(),</span> <span class="n">model_part</span><span class="p">.</span><span class="n">Nodes</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">"Type of value is not available"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_element_condition_replace_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">num_nodes_elements</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">Elements</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">num_nodes_elements</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">Elements</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">GetNodes</span><span class="p">())</span>

        <span class="c1">## Elements
</span>        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">ProcessInfo</span><span class="p">[</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">DOMAIN_SIZE</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">num_nodes_elements</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">"element_replace_settings"</span><span class="p">][</span><span class="s">"element_name"</span><span class="p">].</span><span class="n">SetString</span><span class="p">(</span><span class="s">"EulerianConvDiff2D"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">"element_replace_settings"</span><span class="p">][</span><span class="s">"element_name"</span><span class="p">].</span><span class="n">SetString</span><span class="p">(</span><span class="s">"EulerianConvDiff2D4N"</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">ProcessInfo</span><span class="p">[</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">DOMAIN_SIZE</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">"element_replace_settings"</span><span class="p">][</span><span class="s">"element_name"</span><span class="p">].</span><span class="n">GetString</span><span class="p">()</span> <span class="o">==</span> <span class="s">"EulerianConvDiff"</span><span class="p">):</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">"element_replace_settings"</span><span class="p">][</span><span class="s">"element_name"</span><span class="p">].</span><span class="n">SetString</span><span class="p">(</span><span class="s">"EulerianConvDiff3D"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="s">"DOMAIN_SIZE not set"</span><span class="p">)</span>
        
        <span class="c1">## Conditions
</span>        <span class="n">num_nodes_conditions</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">Conditions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">num_nodes_conditions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">Conditions</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">GetNodes</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">ProcessInfo</span><span class="p">[</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">DOMAIN_SIZE</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">"element_replace_settings"</span><span class="p">][</span><span class="s">"condition_name"</span><span class="p">].</span><span class="n">SetString</span><span class="p">(</span><span class="s">"LineCondition2D2N"</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">ProcessInfo</span><span class="p">[</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">DOMAIN_SIZE</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">"element_replace_settings"</span><span class="p">][</span><span class="s">"condition_name"</span><span class="p">].</span><span class="n">SetString</span><span class="p">(</span><span class="s">"SurfaceCondition3D3N"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="s">"DOMAIN_SIZE not set"</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">"element_replace_settings"</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_set_and_fill_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Prepare nodal solution step data containers and time step information. """</span>
        <span class="c1"># Set the buffer size for the nodal solution steps data. Existing nodal
</span>        <span class="c1"># solution step data may be lost.
</span>        <span class="n">required_buffer_size</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">"buffer_size"</span><span class="p">].</span><span class="n">GetInt</span><span class="p">()</span>
        <span class="n">current_buffer_size</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">GetBufferSize</span><span class="p">()</span>
        <span class="n">buffer_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">current_buffer_size</span><span class="p">,</span> <span class="n">required_buffer_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">SetBufferSize</span><span class="p">(</span><span class="n">buffer_size</span><span class="p">)</span>
        <span class="c1"># Cycle the buffer. This sets all historical nodal solution step data to
</span>        <span class="c1"># the current value and initializes the time stepping in the process info.
</span>        <span class="n">delta_time</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">ProcessInfo</span><span class="p">[</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">DELTA_TIME</span><span class="p">]</span>
        <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">ProcessInfo</span><span class="p">[</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">TIME</span><span class="p">]</span>
        <span class="n">step</span> <span class="o">=-</span><span class="n">buffer_size</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">time</span> <span class="o">-</span> <span class="n">delta_time</span> <span class="o">*</span> <span class="n">buffer_size</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">ProcessInfo</span><span class="p">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">TIME</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">):</span>
            <span class="n">step</span> <span class="o">=</span> <span class="n">step</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">time</span> <span class="o">+</span> <span class="n">delta_time</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">ProcessInfo</span><span class="p">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">STEP</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">CloneTimeStep</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">PrepareModelPartForSolver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            
        <span class="c1"># Check and prepare computing model part and import constitutive laws.
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">_execute_after_reading</span><span class="p">()</span>

        <span class="n">throw_errors</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">TetrahedralMeshOrientationCheck</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">,</span> <span class="n">throw_errors</span><span class="p">).</span><span class="n">Execute</span><span class="p">()</span>
        <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">ReplaceElementsAndConditionsProcess</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">,</span><span class="bp">self</span><span class="p">.</span><span class="n">_get_element_condition_replace_settings</span><span class="p">()).</span><span class="n">Execute</span><span class="p">()</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">_set_and_fill_buffer</span><span class="p">()</span>
        
        <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">Logger</span><span class="p">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s">"::[ConvectionDiffusionBaseSolver]::"</span><span class="p">,</span> <span class="s">"ModelPart prepared for Solver."</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">Initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""Perform initialization after adding nodal variables and dofs to the main model part. """</span>
        <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">Logger</span><span class="p">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s">"::[ConvectionDiffusionBaseSolver]:: "</span><span class="p">,</span> <span class="s">"Initializing ..."</span><span class="p">)</span>

        <span class="c1"># We define the convection diffusion settings
</span>        <span class="n">convention_diffusion_settings</span> <span class="o">=</span> <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">ConvectionDiffusionSettings</span><span class="p">()</span>
        <span class="n">convention_diffusion_settings</span><span class="p">.</span><span class="n">SetDensityVariable</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">DENSITY</span><span class="p">)</span>
        <span class="n">convention_diffusion_settings</span><span class="p">.</span><span class="n">SetDiffusionVariable</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">CONDUCTIVITY</span><span class="p">)</span>
        <span class="n">convention_diffusion_settings</span><span class="p">.</span><span class="n">SetUnknownVariable</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">TEMPERATURE</span><span class="p">)</span>
        <span class="n">convention_diffusion_settings</span><span class="p">.</span><span class="n">SetVolumeSourceVariable</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">HEAT_FLUX</span><span class="p">)</span>
        <span class="n">convention_diffusion_settings</span><span class="p">.</span><span class="n">SetSurfaceSourceVariable</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">FACE_HEAT_FLUX</span><span class="p">)</span>
        <span class="n">convention_diffusion_settings</span><span class="p">.</span><span class="n">SetProjectionVariable</span><span class="p">(</span><span class="n">ConvectionDiffusionApplication</span><span class="p">.</span><span class="n">PROJECTED_SCALAR1</span><span class="p">)</span>
        <span class="n">convention_diffusion_settings</span><span class="p">.</span><span class="n">SetConvectionVariable</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">CONVECTION_VELOCITY</span><span class="p">)</span>
        <span class="n">convention_diffusion_settings</span><span class="p">.</span><span class="n">SetMeshVelocityVariable</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">MESH_VELOCITY</span><span class="p">)</span>
        <span class="n">convention_diffusion_settings</span><span class="p">.</span><span class="n">SetVelocityVariable</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">VELOCITY</span><span class="p">)</span>
        <span class="n">convention_diffusion_settings</span><span class="p">.</span><span class="n">SetSpecificHeatVariable</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">SPECIFIC_HEAT</span><span class="p">)</span>
        <span class="n">convention_diffusion_settings</span><span class="p">.</span><span class="n">SetReactionVariable</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">REACTION_FLUX</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span><span class="p">.</span><span class="n">ProcessInfo</span><span class="p">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">CONVECTION_DIFFUSION_SETTINGS</span><span class="p">,</span> <span class="n">convention_diffusion_settings</span><span class="p">)</span>
            
        <span class="c1"># The mechanical solution strategy is created here if it does not already exist.
</span>        <span class="n">computing_model_part</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">main_model_part</span> <span class="c1"># We will use the main model part
</span>        <span class="c1">#Variable defining the temporal scheme (0: Forward Euler, 1: Backward Euler, 0.5: Crank-Nicolson)
</span>        <span class="n">computing_model_part</span><span class="p">.</span><span class="n">ProcessInfo</span><span class="p">[</span><span class="n">ConvectionDiffusionApplication</span><span class="p">.</span><span class="n">THETA</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">computing_model_part</span><span class="p">.</span><span class="n">ProcessInfo</span><span class="p">[</span><span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">DYNAMIC_TAU</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">conv_diff_scheme</span> <span class="o">=</span> <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">ResidualBasedIncrementalUpdateStaticScheme</span><span class="p">()</span>
        <span class="kn">import</span> <span class="nn">linear_solver_factory</span>
        <span class="n">linear_solver</span> <span class="o">=</span> <span class="n">linear_solver_factory</span><span class="p">.</span><span class="n">ConstructSolver</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">"linear_solver_settings"</span><span class="p">])</span>
        <span class="n">conv_diff_convergence_criterion</span> <span class="o">=</span> <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">ResidualCriteria</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">"residual_relative_tolerance"</span><span class="p">].</span><span class="n">GetDouble</span><span class="p">(),</span> <span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">"residual_absolute_tolerance"</span><span class="p">].</span><span class="n">GetDouble</span><span class="p">())</span>
        <span class="n">builder_and_solver</span> <span class="o">=</span> <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">ResidualBasedBlockBuilderAndSolver</span><span class="p">(</span><span class="n">linear_solver</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">conv_diff_strategy</span> <span class="o">=</span> <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">ResidualBasedNewtonRaphsonStrategy</span><span class="p">(</span><span class="n">computing_model_part</span><span class="p">,</span>  <span class="n">conv_diff_scheme</span><span class="p">,</span> <span class="n">linear_solver</span><span class="p">,</span> <span class="n">conv_diff_convergence_criterion</span><span class="p">,</span> <span class="n">builder_and_solver</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">"max_iteration"</span><span class="p">].</span><span class="n">GetInt</span><span class="p">(),</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">conv_diff_strategy</span><span class="p">.</span><span class="n">SetEchoLevel</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">"echo_level"</span><span class="p">].</span><span class="n">GetInt</span><span class="p">())</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">conv_diff_strategy</span><span class="p">.</span><span class="n">Initialize</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">conv_diff_strategy</span><span class="p">.</span><span class="n">Check</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">"clear_storage"</span><span class="p">].</span><span class="n">GetBool</span><span class="p">():</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">conv_diff_strategy</span><span class="p">.</span><span class="n">Clear</span><span class="p">()</span>
        <span class="n">KratosMultiphysics</span><span class="p">.</span><span class="n">Logger</span><span class="p">.</span><span class="n">PrintInfo</span><span class="p">(</span><span class="s">"::[ConvectionDiffusionBaseSolver]:: "</span><span class="p">,</span> <span class="s">"Finished initialization."</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">Solve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">settings</span><span class="p">[</span><span class="s">"clear_storage"</span><span class="p">].</span><span class="n">GetBool</span><span class="p">():</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">conv_diff_strategy</span><span class="p">.</span><span class="n">Clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">conv_diff_strategy</span><span class="p">.</span><span class="n">Solve</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">InitializeSolutionStep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">conv_diff_strategy</span><span class="p">.</span><span class="n">InitializeSolutionStep</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">Predict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">conv_diff_strategy</span><span class="p">.</span><span class="n">Predict</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">SolveSolutionStep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">is_converged</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">conv_diff_strategy</span><span class="p">.</span><span class="n">SolveSolutionStep</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">is_converged</span>

    <span class="k">def</span> <span class="nf">FinalizeSolutionStep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">conv_diff_strategy</span><span class="p">.</span><span class="n">FinalizeSolutionStep</span><span class="p">()</span>
</code></pre></div></div>


    <!-- <div class="tags">
        
        <b>Tags: </b>
        
        
        
        
        
    </div> -->

</div>



<footer>
            <div class="row">
                <div class="col-lg-12 footer">
               &copy;2022 CIMNE. All rights reserved. <br />
 Site last generated: Dec 30, 2022 <br />
<p style="padding-right:32px;"><br><img src="/images/company_logo.png" alt="Company logo" height="100px"/></p>
                </div>
            </div>
</footer>


        </div>
    <!-- /.row -->
</div>
<!-- /.container -->
</div>
<!-- /#main -->
    </div>

</body>

</html>
